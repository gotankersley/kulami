function drawLine(r,t,e,A,a){r.beginPath(),r.moveTo(t,e),r.lineTo(A,a),r.closePath(),r.stroke()}function drawCircle(r,t,e,A,a){r.beginPath(),r.arc(t+A,e+A,A-a,0,2*Math.PI,!0),r.closePath(),r.fill()}function drawRoundedRect(r,t,e,A,a,I){2*I>A&&(I=A/2),2*I>a&&(I=a/2),r.beginPath(),r.moveTo(t+I,e),r.arcTo(t+A,e,t+A,e+a,I),r.arcTo(t+A,e+a,t,e+a,I),r.arcTo(t,e+a,t,e,I),r.arcTo(t,e,t+A,e,I),r.closePath(),r.fill()}function set(r,t,e){r[t]=e[0],r[t+1]=e[1]}function get(r,t){var e=new Uint32Array([r[t],r[t+1]]);return e}function eq(r,t){return r[0]==t[0]&&r[1]==t[1]?!0:!1}function and(r,t){var e=new Uint32Array([r[0]&t[0],r[1]&t[1]]);return e}function or(r,t){var e=new Uint32Array([r[0]|t[0],r[1]|t[1]]);return e}function xor(r,t){var e=new Uint32Array([r[0]^t[0],r[1]^t[1]]);return e}function xorEq(r,t){r[0]^=t[0],r[1]^=t[1]}function xorEqOff(r,t,e){r[t]^=e[0],r[t+1]^=e[1]}function bitCount(r){var t=r[0];t-=t>>>1&1431655765,t=(858993459&t)+(t>>>2&858993459);var e=16843009*(t+(t>>>4)&252645135)>>>24,A=r[1];return A-=A>>>1&1431655765,A=(858993459&A)+(A>>>2&858993459),e+(16843009*(A+(A>>>4)&252645135)>>>24)}function bitScan(r){for(var t=[],e=r[0];e;){var A=e&-e;t.push(MASK_TO_BIT[A>>>0]),e&=e-1}for(var a=r[1];a;){var A=a&-a;t.push(MASK_TO_BIT[A>>>0]+32),a&=a-1}return t}function Board(r){this.tiles=new Array(GRID_SIZE),this.pins=new Array(GRID_SIZE),this.turn=TURN_PLAYER1,this.last1={r:INVALID,c:INVALID},this.last2={r:INVALID,c:INVALID},this.pinCount1=0,this.pinCount2=0;for(var t=0;GRID_SIZE>t;t++)this.tiles[t]=new Array(GRID_SIZE),this.pins[t]=new Array(GRID_SIZE);this.loadFromString("undefined"!=typeof r?r:defaultBoardStr)}function BB_new(){var r=new Uint32Array([0,0,0,0,BB_INVALID,BB_INVALID,TURN_PLAYER1,0]);return r}function BB_initConstants(){for(var r=0;GRID_SIZE>r;r++)POS[r]=new Array(GRID_SIZE);for(var r=0;BOARD_SIZE>r;r++)MPOS[r]=new Uint32Array(32>r?[1<<r,0]:[0,1<<r])}function BB_calcScore(r){for(var t=SCORE_OFFSET,e=get(r,P1),A=get(r,P2),a=1;TILES_SIZE>a;a++){var I=bitCount(and(TILES_BY_ID[a],e)),n=bitCount(and(TILES_BY_ID[a],A));I>n?t+=TILE_COUNTS_BY_ID[a]:n>I&&(t-=TILE_COUNTS_BY_ID[a])}return t}function BB_fromKBN(r,t){t=t.toUpperCase();var e=2*GRID_SIZE*GRID_SIZE;if(t.length!=e){var A='Invalid kbn length "'+t.length+'", expected '+e;return{status:!1,msg:A}}for(var a=0,I=0,n=new Array(GRID_SIZE),o=new Array(GRID_SIZE),i=0;GRID_SIZE>i;i++)n[i]=new Array(GRID_SIZE),o[i]=new Array(GRID_SIZE);for(var i=0;TILES_SIZE>i;i++)TILES_BY_ID[i]=new Uint32Array(2);for(var i=0;e>i;i+=2){var E=Math.floor(a/GRID_SIZE),_=Math.floor(a%GRID_SIZE),s=t.charAt(i),S=parseInt(-(ASCII_A-s.charCodeAt(0)));if(TILE_EMPTY>S||S>=TILES_SIZE){var A='Invalid tile code "'+s+'" in kbn:'+i+", expected A-R";return{status:!1,msg:A}}n[E][_]=S;var R=t.charAt(i+1),L=parseInt(-(ASCII_0-R.charCodeAt(0)));if(PIN_EMPTY>L||L>PIN_LAST2){var A='Invalid pin code "'+R+'" in kbn:'+i+", expected 0-4";return{status:!1,msg:A}}o[E][_]=L,S==TILE_EMPTY?POS[E][_]=INVALID:(ROW[I]=E,COL[I]=_,POS[E][_]=I,I++),a++}var P=new Uint32Array(2),T=new Uint32Array(2);r[LAST1]=BB_INVALID,r[LAST2]=BB_INVALID;for(var E=0;GRID_SIZE>E;E++)for(var _=0;GRID_SIZE>_;_++)if(n[E][_]!=TILE_EMPTY){var h=POS[E][_],N=MPOS[h],l=n[E][_];if(xorEq(TILES_BY_ID[l],N),o[E][_]!=PIN_EMPTY){var L=o[E][_];L==PIN_PLAYER1?xorEq(P,N):L==PIN_PLAYER2?xorEq(T,N):L==PIN_LAST1?r[LAST1]=h:L==PIN_LAST2&&(r[LAST2]=h)}}for(r[LAST1]!=BB_INVALID&&xorEq(P,MPOS[r[LAST1]]),r[LAST2]!=BB_INVALID&&xorEq(T,MPOS[r[LAST2]]),set(r,P1,P),set(r,P2,T),a=0;BOARD_SIZE>a;a++){var E=ROW[a],_=COL[a],l=n[E][_];TILE_IDS_BY_POS[a]=l,TILES_BY_POS[a]=TILES_BY_ID[l],MOVES[a]=new Uint32Array(2);for(var i=0;GRID_SIZE>i;i++)POS[E][i]!=INVALID&&xorEq(MOVES[a],MPOS[POS[E][i]]),POS[i][_]!=INVALID&&xorEq(MOVES[a],MPOS[POS[i][_]])}for(var u=1;TILES_SIZE>u;u++)TILE_COUNTS_BY_ID[u]=bitCount(TILES_BY_ID[u]);for(a=0;BOARD_SIZE>a;a++){var l=TILE_IDS_BY_POS[a];TILE_COUNTS_BY_POS[a]=TILE_COUNTS_BY_ID[l]}return r[TURN]=bitCount(or(P,T))%2,r[SCORE]=BB_calcScore(r),{status:!0,msg:""}}function BB_toKBN(r){for(var t="",e=get(r,P1),A=get(r,P2),a=0;GRID_SIZE>a;a++)for(var I=0;GRID_SIZE>I;I++){var n=POS[a][I];if(n!=INVALID){var o=TILE_IDS_BY_POS[n];t+=String.fromCharCode(ASCII_A+o);var i=MPOS[n];t+=n==r[LAST1]?String.fromCharCode(ASCII_0+PIN_LAST1):n==r[LAST2]?String.fromCharCode(ASCII_0+PIN_LAST2):eq(and(e,i),i)?String.fromCharCode(ASCII_0+PIN_PLAYER1):eq(and(A,i),i)?String.fromCharCode(ASCII_0+PIN_PLAYER2):"0"}else t+="A0"}return t}function BB_makeMove(r,t){var e=get(r,P1),A=get(r,P2),a=bitCount(and(e,TILES_BY_POS[t])),I=bitCount(and(A,TILES_BY_POS[t]));r[TURN]==TURN_PLAYER1?(xorEqOff(r,P1,MPOS[t]),r[LAST1]=t,a++,Math.abs(a-I)<=1&&a>=I&&(r[SCORE]+=TILE_COUNTS_BY_POS[t])):(xorEqOff(r,P2,MPOS[t]),r[LAST2]=t,I++,Math.abs(I-a)<=1&&I>=a&&(r[SCORE]-=TILE_COUNTS_BY_POS[t])),r[TURN]=!r[TURN]}function BB_getMoves(r){if(r[LAST1]==BB_INVALID)return FULL;var t=r[LAST1],e=r[LAST2];r[TURN]==TURN_PLAYER2&&(t=r[LAST2],e=r[LAST1]);var A=get(r,P1),a=get(r,P2),I=new Uint32Array(MOVES[e]);return xorEq(I,and(I,or(A,a))),xorEq(I,and(I,TILES_BY_POS[e])),t!=BB_INVALID&&xorEq(I,and(I,TILES_BY_POS[t])),I}function BB_getFirstAvailMove(r){var t=bitScan(BB_getMoves(r));return t[0]}function BB_getRandomMove(r){var t=bitScan(BB_getMoves(r));return t[Math.floor(Math.random()*t.length)]}function BB_getLastPos(r){return r[TURN]==TURN_PLAYER1?r[LAST2]:r[LAST1]}function BB_getLastMove(r){return r[TURN]==TURN_PLAYER1?{r:ROW[r[LAST2]],c:COL[r[LAST2]]}:{r:ROW[r[LAST1]],c:COL[r[LAST1]]}}function BB_getWinMove(r){for(var t=bitScan(BB_getMoves(r)),e=0;e<t.length;e++){var A=new Uint32Array(r);BB_makeMove(A,t[e]);var a=BB_getMoves(A);if(eq(a,EMPTY))if(r[TURN]==TURN_PLAYER1){if(A[SCORE]>SCORE_OFFSET)return t[e]}else if(A[SCORE]<SCORE_OFFSET)return t[e]}return!1}function BB_print(r){var t=get(r,P1),e=get(r,P2);console.log("P1",bitScan(t)),console.log("P2",bitScan(e))}function BB_simulate(r){for(var t=new Uint32Array(r),e=get(t,P1),A=get(t,P2),a=bitCount(or(e,A)),I=0;PINS_SIZE-a>I;I++){var n=BB_getMoves(t);if(eq(n,EMPTY))break;var o=bitScan(n);BB_makeMove(t,o[Math.floor(Math.random()*o.length)])}return t[SCORE]>SCORE_OFFSET?r[TURN]==TURN_PLAYER1?WIN:LOSE:t[SCORE]<SCORE_OFFSET?r[TURN]==TURN_PLAYER2?WIN:LOSE:TIE}function Players(r,t){this.player1="undefined"!=typeof r?r:PLAYER_HUMAN,this.player2="undefined"!=typeof t?t:PLAYER_HUMAN}function MenuProperties(){this.hopelessMode=!1,this.showAxes=!0,this.showGrid=!1,this.showPinsRemaining=!0,this.showScore=!0,this.showScoreMap=!1,this.suggest=suggestMove,this.moveDelay=0,this.tileRounding=TILE_RADIUS_SIZE,this.board=0,this.player1=PLAYER_HUMAN,this.player2=PLAYER_HUMAN}function MenuManager(){this.properties=new MenuProperties,this.rootMenu=new dat.GUI;var r=this.rootMenu.addFolder("Options");r.add(this.properties,"hopelessMode").onChange(this.onScoreToggle),r.add(this.properties,"moveDelay",0,1e4),r.add(this.properties,"tileRounding",0,UNIT_SIZE),r.add(this.properties,"showAxes"),r.add(this.properties,"showGrid"),r.add(this.properties,"showPinsRemaining"),r.add(this.properties,"showScoreMap"),r.add(this.properties,"suggest");var t={Default:0,Irregular:1,Team1:2,Team2:3,Team3:4,Team4:5,Team5:6,Team6:7,Team7:8};this.rootMenu.add(this.properties,"board",t).onChange(this.onBoardChange);var e={Human:PLAYER_HUMAN,Weak:PLAYER_HEURISTIC,Good:PLAYER_ALPHA};this.rootMenu.add(this.properties,"player1",e).onChange(this.onChangePlayer),this.rootMenu.add(this.properties,"player2",e).onChange(this.onChangePlayer)}function suggestMove(){menu.showScoreMap=!0;for(var r=0;GRID_SIZE>r;r++)for(var t=0;GRID_SIZE>t;t++)game.scoreMap[r][t]="";AB.getMove(game.board)}function Game(r){this.board=new Board(r),this.tileShapes=new Array(TILES_SIZE),this.scoreMap=new Array(GRID_SIZE);for(var t=0;GRID_SIZE>t;t++){var e=t*UNIT_SIZE;this.scoreMap[t]=new Array(GRID_SIZE);for(var A=0;GRID_SIZE>A;A++){this.scoreMap[t][A]="";var a=A*UNIT_SIZE,I=this.board.tiles[t][A],n=this.tileShapes[I];I!=TILE_EMPTY&&("undefined"==typeof n?this.tileShapes[I]={x:a+TILE_MARGIN_SIZE,y:e+TILE_MARGIN_SIZE,w:0,h:0}:(this.tileShapes[I].w=Math.max(n.w,a-n.x+UNIT_SIZE-TILE_MARGIN_SIZE),this.tileShapes[I].h=Math.max(n.h,e-n.y+UNIT_SIZE-TILE_MARGIN_SIZE)))}}this.players=new Players(PLAYER_HUMAN,PLAYER_HUMAN),this.cursorR=0,this.cursorC=0;var o=document.getElementById("mainCanvas"),i=document.getElementById("pinCanvas");this.ctx=o.getContext("2d"),this.pinCtx=i.getContext("2d"),this.ctx.font="20px Georgia",this.draw()}var MASK_TO_BIT={1:0,2:1,4:2,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10,2048:11,4096:12,8192:13,16384:14,32768:15,65536:16,131072:17,262144:18,524288:19,1048576:20,2097152:21,4194304:22,8388608:23,16777216:24,33554432:25,67108864:26,134217728:27,268435456:28,536870912:29,1073741824:30,2147483648:31},GRID_SIZE=10,BOARD_SIZE=64,PINS_SIZE=56,PINS_PER_PLAYER=28,TILES_SIZE=18,TILE_EMPTY=0,PIN_EMPTY=0,PIN_PLAYER1=1,PIN_PLAYER2=2,PIN_LAST1=3,PIN_LAST2=4,ASCII_A=65,ASCII_0=48,TURN_PLAYER1=0,TURN_PLAYER2=1,INVALID=-1,WIN=1,LOSE=-1,TIE=0,defaultBoardStr="B0B0C0D0D0D0E0E0A0A0B0B0C0F0F0G0E0E0A0A0H0H0C0F0F0G0E0E0A0A0H0H0I0I0I0J0J0J0A0A0K0K0I0I0I0L0L0M0A0A0N0O0O0P0P0L0L0M0A0A0N0O0O0Q0Q0Q0R0R0A0A0N0O0O0Q0Q0Q0R0R0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0",irrBoardStr="A0A0A0A0B0B0A0A0A0A0A0A0C0C0B0B0D0A0A0A0E0E0C0C0F0F0D0A0A0A0E0E0G0H0H0H0D0I0I0I0E0E0G0H0H0H0J0J0J0A0K0K0G0L0L0L0J0J0J0A0A0A0M0M0N0O0O0P0P0A0A0A0M0M0N0O0O0P0P0A0A0A0A0Q0Q0R0R0P0P0A0A0A0A0A0A0R0R0A0A0A0",KBNS=["B0B0C0D0D0D0E0E0A0A0B0B0C0F0F0G0E0E0A0A0H0H0C0F0F0G0E0E0A0A0H0H0I0I0I0J0J0J0A0A0K0K0I0I0I0L0L0M0A0A0N0O0O0P0P0L0L0M0A0A0N0O0O0Q0Q0Q0R0R0A0A0N0O0O0Q0Q0Q0R0R0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","A0A0A0A0B0B0A0A0A0A0A0A0C0C0B0B0D0A0A0A0E0E0C0C0F0F0D0A0A0A0E0E0G0H0H0H0D0I0I0I0E0E0G0H0H0H0J0J0J0A0K0K0G0L0L0L0J0J0J0A0A0A0M0M0N0O0O0P0P0A0A0A0M0M0N0O0O0P0P0A0A0A0A0Q0Q0R0R0P0P0A0A0A0A0A0A0R0R0A0A0A0","B0B0B0C0C0D0D0D0A0A0E0E0E0C0C0D0D0D0A0A0F0G0G0H0H0I0I0I0A0A0F0J0J0H0H0I0I0I0A0A0F0K0K0L0L0M0M0M0A0A0N0O0O0L0L0M0M0M0A0A0N0P0P0Q0Q0R0R0R0A0A0N0P0P0Q0Q0R0R0R0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","B0C0C0C0D0D0E0E0A0A0B0C0C0C0D0D0E0E0A0A0B0F0G0G0H0H0E0E0A0A0I0F0J0J0H0H0K0K0A0A0I0F0L0L0M0M0K0K0A0A0N0O0O0O0M0M0K0K0A0A0N0P0P0P0Q0Q0R0R0A0A0N0P0P0P0Q0Q0R0R0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","B0C0C0D0D0E0E0E0A0A0B0C0C0F0F0E0E0E0A0A0G0G0G0F0F0H0H0I0A0A0J0J0K0K0K0H0H0I0A0A0J0J0K0K0K0L0L0I0A0A0M0M0M0N0N0O0P0P0A0A0Q0Q0Q0R0R0O0P0P0A0A0Q0Q0Q0R0R0O0P0P0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","B0B0B0C0D0D0E0E0A0A0B0B0B0C0D0D0E0E0A0A0F0G0G0C0H0H0E0E0A0A0F0G0G0I0H0H0J0K0A0A0L0L0L0I0M0M0J0K0A0A0L0L0L0N0M0M0J0O0A0A0P0P0Q0N0R0R0R0O0A0A0P0P0Q0N0R0R0R0O0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","B0B0B0C0C0C0D0D0A0A0E0E0F0F0G0G0D0D0A0A0E0E0H0H0G0G0I0I0A0A0J0J0H0H0K0K0I0I0A0A0L0L0L0M0K0K0I0I0A0A0L0L0L0M0K0K0N0N0A0A0O0O0P0M0Q0Q0N0N0A0A0O0O0P0R0R0R0N0N0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","B0B0B0C0C0D0D0E0A0A0F0G0G0C0C0H0H0E0A0A0F0G0G0C0C0H0H0E0A0A0I0I0I0J0J0K0K0K0A0A0I0I0I0J0J0K0K0K0A0A0L0M0M0N0N0O0O0P0A0A0L0M0M0N0N0O0O0P0A0A0L0Q0Q0N0N0R0R0R0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0","B0B0C0C0C0D0E0E0A0A0B0B0C0C0C0D0F0F0A0A0G0G0H0I0I0D0F0F0A0A0G0G0H0I0I0J0J0J0A0A0G0G0K0K0K0J0J0J0A0A0L0L0M0M0N0O0P0P0A0A0Q0Q0M0M0N0O0R0R0A0A0Q0Q0M0M0N0O0R0R0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0A0"];Board.prototype.copy=function(){var r=new Board;r.pinCount1=this.pinCount1,r.pinCount2=this.pinCount2,r.last1.r=this.last1.r,r.last1.c=this.last1.c,r.last2.r=this.last2.r,r.last2.c=this.last2.c,r.turn=this.turn;for(var t=0;GRID_SIZE>t;t++)for(var e=0;GRID_SIZE>e;e++)r.tiles[t][e]=this.tiles[t][e],r.pins[t][e]=this.pins[t][e];return r},Board.prototype.loadFromString=function(r){r=r.toUpperCase();for(var t=0,e=0;2*GRID_SIZE*GRID_SIZE>e;e+=2){var A=Math.floor(t/GRID_SIZE),a=Math.floor(t%GRID_SIZE),I=r.charAt(e),n=parseInt(-(ASCII_A-I.charCodeAt(0)));if(TILE_EMPTY>n||n>=TILES_SIZE)return alert('Error parsing tile "'+I+'": '+r),!1;this.tiles[A][a]=n;var o=r.charAt(e+1),i=parseInt(-(ASCII_0-o.charCodeAt(0)));if(PIN_EMPTY>i||i>PIN_LAST2)return alert('Error parsing pin: "'+o+'": '+r),!1;i==PIN_LAST1?(this.pins[A][a]=PIN_PLAYER1,this.last1={r:A,c:a}):i==PIN_LAST2?(this.pins[A][a]=PIN_PLAYER2,this.last2={r:A,c:a}):this.pins[A][a]=i,t++}return!0},Board.prototype.toString=function(){for(var r="",t=0;GRID_SIZE>t;t++)for(var e=0;GRID_SIZE>e;e++)r+=String.fromCharCode(ASCII_A+this.tiles[t][e]),r+=String.fromCharCode(t==this.last1.r&&e==this.last1.c?ASCII_0+PIN_LAST1:t==this.last2.r&&e==this.last2.c?ASCII_0+PIN_LAST2:ASCII_0+this.pins[t][e]);return r},Board.prototype.isValid=function(r,t){if(this.pinCount1+this.pinCount2>=PINS_SIZE)return!1;if(0>r||r>=GRID_SIZE||0>t||t>=GRID_SIZE)return!1;if(this.tiles[r][t]==TILE_EMPTY)return!1;if(this.pins[r][t]!=PIN_EMPTY)return!1;if(this.last1.r==INVALID)return!0;var e=this.turn==TURN_PLAYER1?this.last1:this.last2,A=this.turn==TURN_PLAYER1?this.last2:this.last1;return r!=A.r&&t!=A.c?!1:this.tiles[r][t]==this.tiles[A.r][A.c]?!1:e.r==INVALID?!0:this.tiles[r][t]==this.tiles[e.r][e.c]?!1:!0},Board.prototype.isGameOver=function(){return this.pinCount1+this.pinCount2>=PINS_SIZE?!0:0==this.getMoves().length?!0:!1},Board.prototype.getMoves=function(){var r=[];if(this.last1.r==INVALID)for(var t=0;GRID_SIZE>t;t++)for(var e=0;GRID_SIZE>e;e++)this.tiles[t][e]!=TILE_EMPTY&&r.push({r:t,c:e});else for(var A=this.turn==TURN_PLAYER1?this.last1:this.last2,a=A.r==INVALID?INVALID:this.tiles[A.r][A.c],I=this.turn==TURN_PLAYER1?this.last2:this.last1,n=this.tiles[I.r][I.c],o=0;GRID_SIZE>o;o++){var i=this.tiles[I.r][o];this.pins[I.r][o]==PIN_EMPTY&&i!=TILE_EMPTY&&i!=n&&i!=a&&r.push({r:I.r,c:o});var E=this.tiles[o][I.c];this.pins[o][I.c]==PIN_EMPTY&&E!=TILE_EMPTY&&E!=n&&E!=a&&r.push({r:o,c:I.c})}return r},Board.prototype.score=function(){for(var r=new Array(TILES_SIZE),t=new Array(TILES_SIZE),e=new Array(TILES_SIZE),A=1;TILES_SIZE>A;A++)r[A]=0,t[A]=0,e[A]=0;for(var a=0;GRID_SIZE>a;a++)for(var I=0;GRID_SIZE>I;I++){var n=this.tiles[a][I];n!=TILE_EMPTY&&(this.pins[a][I]==PIN_PLAYER1?r[n]++:this.pins[a][I]==PIN_PLAYER2&&t[n]++,e[n]++)}for(var o={p1:0,p2:0},A=1;TILES_SIZE>A;A++)r[A]>t[A]?o.p1+=e[A]:t[A]>r[A]&&(o.p2+=e[A]);return o},Board.prototype.makeMove=function(r,t){this.turn==TURN_PLAYER1?(this.pins[r][t]=PIN_PLAYER1,this.last1={r:r,c:t},this.pinCount1++):(this.pins[r][t]=PIN_PLAYER2,this.last2={r:r,c:t},this.pinCount2++),this.turn=!this.turn};var BB_INVALID=4294967295,SCORE_OFFSET=100,P1=0,P2=2,P1_LO=0,P1_HI=1,P2_LO=2,P2_HI=3,LAST1=4,LAST2=5,TURN=6,SCORE=7,EMPTY=new Uint32Array([0,0]),FULL=new Uint32Array([4294967295,4294967295]),MPOS=new Array(BOARD_SIZE),POS=new Array(BOARD_SIZE),ROW=new Array(BOARD_SIZE),COL=new Array(BOARD_SIZE),MOVES=new Array(BOARD_SIZE),TILES_BY_POS=new Array(BOARD_SIZE),TILES_BY_ID=new Array(TILES_SIZE),TILE_IDS_BY_POS=new Array(BOARD_SIZE),TILE_COUNTS_BY_POS=new Array(BOARD_SIZE),TILE_COUNTS_BY_ID=new Array(TILES_SIZE),PLAYER_HUMAN=0,PLAYER_RANDOM=1,PLAYER_HEURISTIC=2,PLAYER_EM=3,PLAYER_AB=4,PLAYER_MC=5,PLAYER_BB=6,PLAYER_ALPHA=7;Players.prototype.getCurrent=function(r){return r.turn==TURN_PLAYER1?this.player1:this.player2},Players.prototype.getMove=function(r,t){for(var e=0;GRID_SIZE>e;e++)for(var A=0;GRID_SIZE>A;A++)game.scoreMap[e][A]="";var a=this.getCurrent(r),I=r.getMoves();if(0==I.length)t({r:INVALID,c:INVALID});else if(1==I.length)t(I[0]);else if(a==PLAYER_BB)MC.getMove(r,t);else{var n;n=a==PLAYER_RANDOM?this.getRandom(r):a==PLAYER_HEURISTIC?this.getHeuristic(r):a==PLAYER_AB?this.getNative(r,"ab"):a==PLAYER_MC?this.getNative(r,"mc"):a==PLAYER_EM?this.getEm(r):a==PLAYER_ALPHA?AB.getMove(r):{r:INVALID,c:INVALID},t(n)}},Players.prototype.getEm=function(){var r=Module.ccall("getMove","number",[],[]),t=255&r,e=(65280&r)>>8;return{r:t,c:e}},Players.prototype.getNative=function(r,t){var e={r:INVALID,c:INVALID},A="/ai?board="+r.toString()+"&engine="+t;return $.ajax({url:A,success:function(r){0==r?alert("no moves available"):r.length>2?alert("Invalid moveStr: "+r):(e.c=parseInt(-(ASCII_A-r.charCodeAt(0))),e.r=parseInt(-(ASCII_0-r.charCodeAt(1))))},async:!1}),e},Players.prototype.getRandom=function(r){var t=r.getMoves();return 0==t.length?{r:INVALID,c:INVALID}:t[Math.floor(Math.random()*t.length)]},Players.prototype.getHeuristic=function(r){for(var t,e=r.getMoves(),A=INVALID,a=r.turn==TURN_PLAYER1?TURN_PLAYER1:TURN_PLAYER2,I=0;I<e.length;I++){var n=r.copy();n.makeMove(e[I].r,e[I].c);var o=n.score(),i=a==TURN_PLAYER1?o.p1:o.p2;menu.showScoreMap&&(game.scoreMap[e[I].r][e[I].c]=i),i>A&&(A=i,t=I)}return e[t]},MenuManager.prototype.onChangePlayer=function(){game.players=new Players(menu.player1,menu.player2),game.onMoveStart()},MenuManager.prototype.onBoardChange=function(r){game=new Game(KBNS[r])},MenuManager.prototype.onScoreToggle=function(){$("#score").toggle()};var CANVAS_SIZE=800,UNIT_SIZE=CANVAS_SIZE/GRID_SIZE,HALF_UNIT=UNIT_SIZE/2,QUARTER_UNIT=UNIT_SIZE/4,TILE_RADIUS_SIZE=20,TILE_MARGIN_SIZE=4,PIN_HOLE_SIZE=UNIT_SIZE/6,PIN_RADIUS_SIZE=UNIT_SIZE/3,COLOR_BLACK="#000",COLOR_TILE_EDGE="#493d26",COLOR_AXES="#a9a9f5",COLOR_CURSOR="#7C6741",COLOR_P1="#f00",COLOR_P2="#303030",COLOR_P1_EDGE="#600",COLOR_P2_EDGE="#000",COLOR_TILE="#deb887",COLOR_TILE_DISABLED="#8E775A";Game.prototype.onMoveStart=function(){this.board.isGameOver()||this.players.getCurrent(this.board)!=PLAYER_HUMAN&&this.players.getMove(this.board,function(r){game.onMakeMove(r.r,r.c)})},Game.prototype.onMakeMove=function(r,t){this.board.isValid(r,t)?(this.board.makeMove(r,t),this.onMoveMade(r,t)):this.onInvalidMove(r,t)},Game.prototype.onMoveMade=function(){var r=this.board.score();$("#score").text(r.p1+" - "+r.p2),this.board.isGameOver()?this.onGameOver():($("#turn").attr("class","turn"+(this.board.turn+1)),this.players.getCurrent(this.board)!=PLAYER_HUMAN&&setTimeout(function(){game.onMoveStart()},menu.moveDelay+10))},Game.prototype.onInvalidMove=function(r,t){console.log("Invalid move: ",r,t),alert("Invalid move: "+r+","+t)},Game.prototype.onGameOver=function(){var r,t,e=this.board.score(),A=this.board.pinCount1+this.board.pinCount2<PINS_SIZE?"No moves - ":"";e.p1>e.p2?(r=A+"Red WINS!!",t="win1"):e.p2>e.p1?(r=A+"Black WINS!!",t="win2"):(r=A+"Tie score!",t="tie"),$("#turn").attr("class",t),$("#turn").text(r),alert(r)},Game.prototype.onClick=function(r){var t,e;void 0==r.offsetX?(t=r.pageX-$("#mainCanvas").offset().left,e=r.pageY-$("#mainCanvas").offset().top):(t=r.offsetX,e=r.offsetY);var A=Math.floor(e/UNIT_SIZE),a=Math.floor(t/UNIT_SIZE);game.players.getCurrent(game.board)==PLAYER_HUMAN&&A>=0&&GRID_SIZE>A&&a>=0&&GRID_SIZE>a&&game.board.tiles[A][a]!=TILE_EMPTY&&(game.board.isValid(A,a)?(game.board.makeMove(A,a),game.onMoveMade(A,a)):game.onInvalidMove(A,a))},Game.prototype.onMouse=function(r){var t,e;void 0==r.offsetX?(t=r.pageX-$("#mainCanvas").offset().left,e=r.pageY-$("#mainCanvas").offset().top):(t=r.offsetX,e=r.offsetY),game.cursorR=Math.floor(e/UNIT_SIZE),game.cursorC=Math.floor(t/UNIT_SIZE)},Game.prototype.draw=function(){var r=this.board,t=r.last1,e=r.last2;r.turn==TURN_PLAYER2&&(t=r.last2,e=r.last1);var A=e.c*UNIT_SIZE,a=e.r*UNIT_SIZE,I=t.c*UNIT_SIZE,n=t.r*UNIT_SIZE,o=this.ctx;o.clearRect(0,0,CANVAS_SIZE,CANVAS_SIZE);var i=this.pinCtx;i.clearRect(0,0,200,CANVAS_SIZE);var E=GRID_SIZE*UNIT_SIZE;o.lineWidth=5;for(var _=1;TILES_SIZE>_;_++){var s=this.tileShapes[_];o.fillStyle=menu.hopelessMode||e.r==INVALID?COLOR_TILE:A+HALF_UNIT>=s.x&&A<=s.x+s.w&&a+HALF_UNIT>=s.y&&a<=s.y+s.h?COLOR_TILE_DISABLED:I+HALF_UNIT>=s.x&&I<=s.x+s.w&&n+HALF_UNIT>=s.y&&n<=s.y+s.h?COLOR_TILE_DISABLED:COLOR_TILE,drawRoundedRect(o,s.x,s.y,s.w,s.h,menu.tileRounding),o.strokeStyle=COLOR_TILE_EDGE,o.stroke()}if(menu.showAxes&&!menu.hopelessMode&&e.r!=INVALID){o.strokeStyle=COLOR_AXES;var S=a+HALF_UNIT,R=A+HALF_UNIT;drawLine(o,0,S,E,S),drawLine(o,R,0,R,E)}for(var L=HALF_UNIT-PIN_HOLE_SIZE,P=HALF_UNIT-PIN_RADIUS_SIZE,T=0;GRID_SIZE>T;T++)for(var h=T*UNIT_SIZE,N=0;GRID_SIZE>N;N++){var l=N*UNIT_SIZE,u=r.tiles[T][N],O=r.pins[T][N];if(u==TILE_EMPTY)o.fillStyle="#fff",o.fillRect(l,h,UNIT_SIZE,UNIT_SIZE);else if(O!=PIN_EMPTY)O==PIN_PLAYER1?(o.fillStyle=COLOR_P1,o.strokeStyle=COLOR_P1_EDGE):O==PIN_PLAYER2&&(o.fillStyle=COLOR_P2,o.strokeStyle=COLOR_P2_EDGE),drawCircle(o,l+P,h+P,PIN_RADIUS_SIZE,0),o.lineWidth=2,o.stroke();else if(T==this.cursorR&&N==this.cursorC){{this.cursorC*UNIT_SIZE,this.cursorR*UNIT_SIZE}o.fillStyle=r.turn==TURN_PLAYER1?COLOR_P1:COLOR_P2,drawCircle(o,l+L-5,h+L-5,PIN_HOLE_SIZE+5,0)}else o.fillStyle=COLOR_TILE_EDGE,drawCircle(o,l+L,h+L,PIN_HOLE_SIZE,0)}if(menu.showGrid){o.lineWidth=1,o.strokeStyle=COLOR_BLACK;for(var C=0;GRID_SIZE>C;C++){var f=C*UNIT_SIZE;drawLine(o,f,0,f,E),drawLine(o,0,f,E,f)}}if(!menu.hopelessMode){i.fillStyle=COLOR_P1;for(var C=0;C<PINS_PER_PLAYER-r.pinCount1;C++){var T=Math.floor(C/4),N=C%4,l=2*(PIN_HOLE_SIZE+1)*N,h=2*(PIN_HOLE_SIZE+1)*T;drawCircle(i,l,h+50,PIN_HOLE_SIZE,0)}i.fillStyle=COLOR_P2;for(var C=r.pinCount2;PINS_PER_PLAYER>C;C++){var T=Math.floor(C/4),N=C%4,l=2*(PIN_HOLE_SIZE+1)*N,h=2*(PIN_HOLE_SIZE+1)*T;drawCircle(i,l,h+350,PIN_HOLE_SIZE,0)}}if(menu.showScoreMap)for(var T=0;GRID_SIZE>T;T++)for(var h=(T+1)*UNIT_SIZE-QUARTER_UNIT+5,N=0;GRID_SIZE>N;N++){var l=N*UNIT_SIZE+QUARTER_UNIT;if(this.board.tiles[T][N]!=TILE_EMPTY){var M=this.scoreMap[T][N];1e5==M?o.fillText("Win",l,h):-1e5==M?o.fillText("Loss",l,h):o.fillText(this.scoreMap[T][N],l,h)}}requestAnimationFrame(this.draw.bind(this))};var AB=new function(){var r=10,t=1e5,e=[],A=function(r,t){return r[TURN]==TURN_PLAYER1?r[SCORE]-t[SCORE]:t[SCORE]-r[SCORE]};this.getMove=function(A){BB_initConstants(),bb=BB_new();var I=(BB_fromKBN(bb,A.toString()),bitCount(or(bb,get(bb,P2))));r=0==I?8:4>=I?10:6>=I?12:20>=I?13:30>=I?14:32>=I?15:34>=I?16:36>=I?18:38>=I?20:25,e=new Array(r);var n=a(bb,-t,t,0),o=e[0];if(n==-t){var i=BB_getFirstAvailMove(bb);return{r:ROW[i],c:COL[i]}}return{r:ROW[o],c:COL[o]}};var a=function(I,n,o,i){if(i>=r)return I[TURN]==TURN_PLAYER1?I[SCORE]-SCORE_OFFSET:-(I[SCORE]-SCORE_OFFSET);var E=BB_getMoves(I);if(eq(E,EMPTY))return I[SCORE]==SCORE_OFFSET?0:I[TURN]==TURN_PLAYER1?I[SCORE]>SCORE_OFFSET?t:-t:I[SCORE]<SCORE_OFFSET?t:-t;for(var _=bitScan(E),s=[],S=0;S<_.length;S++){var R=new Uint32Array(I);BB_makeMove(R,_[S]),s.push(R)}s.sort(A),e[i]=INVALID;for(var L=-t,S=0;S<s.length;S++){var P=s[S],T=a(P,-o,-Math.max(n,L),i+1),h=-T;if(menu.showScoreMap&&0==i){var N=P[TURN]==TURN_PLAYER1?P[LAST2]:P[LAST1];game.scoreMap[ROW[N]][COL[N]]=h}if(h>L&&(L=h,e[i]=P[TURN]==TURN_PLAYER1?P[LAST2]:P[LAST1],L>=o))return L}return L}},game,menu;$(function(){var r=new MenuManager;menu=r.properties,game=new Game;var t=document.getElementById("mainCanvas");$(t).click(game.onClick),$(t).mousemove(game.onMouse)});